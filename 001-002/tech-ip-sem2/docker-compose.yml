services:
  # Auth Service
  auth:
    build:
      context: .
      dockerfile: services/auth/Dockerfile
    container_name: pz17-auth
    ports:
      - "8081:8081"
      - "50051:50051" 
    environment:
      - AUTH_PORT=8081
      - AUTH_GRPC_PORT=50051
    restart: unless-stopped
    mem_limit: 100m
    cpus: 0.3
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/v1/auth/verify", "--header=Authorization: Bearer demo-token-for-student"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - pz17-network

  # Tasks Service
  tasks:
    build:
      context: .
      dockerfile: services/tasks/Dockerfile
    container_name: pz17-tasks
    ports:
      - "8082:8082"
    environment:
      - TASKS_PORT=8082
      - AUTH_GRPC_ADDR=auth:50051 
    depends_on:
      auth:
        condition: service_healthy
    restart: unless-stopped
    mem_limit: 120m
    cpus: 0.5
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8082/v1/tasks", "--header=Authorization: Bearer demo-token-for-student"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    networks:
      - pz17-network

networks:
  pz17-network:
    driver: bridge